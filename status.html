<html>
<body onload='getDetails();'>
<script>
  async function fetchStatus(ip, name, row) {
    try {
      const response = await fetch('http://' + ip + ':3030/status');
      const state = await response.json();    
      if (!state['validator_account_id']) {
        name.innerText = 'RPC';
      } else {
        name.innerText = state['validator_account_id'];
      }
      for (const data of [
          state['version'],
          state['protocol_version'],
          state['sync_info']['latest_block_height'],
          state['sync_info']['syncing'],
          state['uptime_sec']
        ]) {
        const field = document.createElement('td');
        field.innerText = data;
        row.appendChild(field);
      }
    } catch (error) {
      console.log(error);
      name.innerText = 'Unavailable';
    }
  }

  async function getDetails() {
    const response = await fetch('https://nearone-nodes-ips.storage.googleapis.com/ips');
    const content = document.getElementById('content');
    const ips = await response.json();
    for (const network in ips) {
      const table = document.createElement('table');
      table.border = 1;
      table.cellPadding = 10;
      const netHeaders = document.createElement('tr');
      const netHeader = document.createElement('th');
      netHeader.colSpan = 10;
      netHeader.innerText = network;
      netHeaders.appendChild(netHeader);
      table.appendChild(netHeaders);
      const headers = document.createElement('tr');
      for (const header of ['Validator Name', 'IP', 'Debug UI', 'Status Page', 'Debug Page', 'Version', 'Protocol Version', 'Latest Block Height', 'Syncing', 'Uptime (s)']) {
        const th = document.createElemnet('th');
        th.innerText = header;
        headers.appendChild(th);
      }
      table.appendChild(headers);
      for (const ip of ips[network]) {
        const row = document.createElement('tr');
        // This will contain the validator name or 'RPC' if not a validator
        const name = document.createElement('td');
        name.innerText = 'Loading...';
        row.appendChild(name);
        fetchStatus(ip, name, row);
        const ipField = document.createElement('td');
        ipField.innerText = ip;
        row.appendChild(ipField);
        for (const [title, href] of Object.entries({
            'Debug UI': 'http://debug.nearone.org/' + ip,
            'Status page': 'http://' + ip + ':3030/status',
            'Debug page': 'http://' + ip + ':3030/debug'
          })) {
          const field = document.createElement('td');
          const link = document.createElement('a');
          link.innerText = title;
          link.href = href;
          field.appendChild(link);
          row.appendChild(field);
        }
        table.appendChild(row);
      }
      content.appendChild(table);
      content.appendChild(document.createElement('br'));
    }
  }
</script>
<div id='content'></div>
</body>
</html>
